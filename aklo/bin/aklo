#!/usr/bin/env bash
#==============================================================================
# The Aklo Protocol - Charte Automation Tool v3.1 (avec --dry-run)
#==============================================================================

# --- Configuration et chemins ---
SCRIPT_PATH=$(realpath "${BASH_SOURCE[0]}" 2>/dev/null || readlink -f "${BASH_SOURCE[0]}")
AKLO_BIN_DIR=$(dirname "$SCRIPT_PATH")
export AKLO_PROJECT_ROOT
AKLO_PROJECT_ROOT=$(cd "$AKLO_BIN_DIR/../.." && pwd)
export AKLO_MODULES_DIR="${AKLO_PROJECT_ROOT}/aklo/modules"

# --- Gestion de l'option universelle --dry-run ---
export AKLO_DRY_RUN=false
PROCESSED_ARGS=()
for arg in "$@"; do
  if [ "$arg" = "--dry-run" ]; then
    AKLO_DRY_RUN=true
  else
    PROCESSED_ARGS+=("$arg")
  fi
done
# Remplacer les arguments originaux par les arguments traitÃ©s
set -- "${PROCESSED_ARGS[@]}"

if [ "$AKLO_DRY_RUN" = true ]; then
  echo "ðŸ’§ Mode DRY-RUN activÃ©. Aucune modification ne sera effectuÃ©e."
  echo "------------------------------------------------------------------"
fi

# --- Chargement de l'architecture modulaire ---
source "${AKLO_MODULES_DIR}/core/command_classifier.sh"
command_name="$1"
if [ -z "$command_name" ]; then command_name="help"; fi
profile=$(classify_command "$command_name")
required_modules_str=$(get_required_modules "$profile")
if [ -n "$required_modules_str" ]; then
    for module_rel_path in $required_modules_str; do
        module_full_path="${AKLO_MODULES_DIR}/${module_rel_path}"
        if [ -f "$module_full_path" ]; then
            source "$module_full_path"
        else
            echo "Erreur critique : DÃ©pendance de module introuvable : $module_rel_path" >&2
            exit 1
        fi
    done
else
    if [ "$profile" = "UNKNOWN" ]; then
        echo "Erreur: Commande '$command_name' inconnue." >&2
        exit 1
    fi
fi

# --- ExÃ©cution de la commande ---
main() {
    local cmd_func="cmd_$1"
    shift
    if declare -f "$cmd_func" >/dev/null; then
        "$cmd_func" "$@"
    else
        echo "Erreur interne: la fonction pour la commande '$command_name' n'a pas Ã©tÃ© chargÃ©e." >&2
    fi
}

main "$@"