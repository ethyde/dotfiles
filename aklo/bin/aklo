#!/usr/bin/env bash
#==============================================================================
# AKLO - CHARTE AUTOMATION TOOL (V4.3 - STABLE FINALE ET COMPLÃˆTE)
#==============================================================================

main() {
    # --- GESTION PRÃ‰COCE DE L'AIDE ---
    if [[ "$1" == "--help" || "$1" == "-h" || "$1" == "help" || -z "$1" ]]; then
        echo "Usage: aklo <command> [options]"
        echo "Ex: aklo status, aklo new pbi \"Un titre\""
        return 0
    fi

    # --- DÃ‰FINITION FIABLE DU CONTEXTE ---
    local AKLO_TOOL_REAL_PATH
    AKLO_TOOL_REAL_PATH=$(realpath "$0")
    export AKLO_TOOL_DIR
    AKLO_TOOL_DIR=$(dirname "$(dirname "$AKLO_TOOL_REAL_PATH")")
    export AKLO_PROJECT_ROOT
    AKLO_PROJECT_ROOT=$(pwd)

    # --- PARSING DES ARGUMENTS ---
    local command="$1"
    shift
    export AKLO_DRY_RUN=false
    local args=()
    for arg in "$@"; do
        if [ "$arg" = "--dry-run" ]; then
            export AKLO_DRY_RUN=true
        else
            args+=("$arg")
        fi
    done
    set -- "${args[@]}"

    # --- CHARGEMENT COMPLET DES MODULES ---
    local MODULES_DIR="${AKLO_TOOL_DIR}/modules"
    source "${MODULES_DIR}/core/config.sh"
    source "${MODULES_DIR}/core/parser.sh"
    source "${MODULES_DIR}/cache/cache_functions.sh"
    source "${MODULES_DIR}/commands/system_commands.sh"
    source "${MODULES_DIR}/commands/new_command.sh"
    source "${MODULES_DIR}/commands/pbi_commands.sh"
    source "${MODULES_DIR}/commands/task_commands.sh"
    source "${MODULES_DIR}/commands/start-task_command.sh"
    source "${MODULES_DIR}/commands/submit-task_command.sh"
    source "${MODULES_DIR}/commands/merge-task_command.sh"
    source "${MODULES_DIR}/commands/release_command.sh"
    source "${MODULES_DIR}/commands/hotfix_command.sh"
    source "${MODULES_DIR}/commands/debug_command.sh"
    source "${MODULES_DIR}/commands/refactor_command.sh"
    source "${MODULES_DIR}/commands/optimize_command.sh"
    source "${MODULES_DIR}/commands/security_command.sh"
    source "${MODULES_DIR}/commands/experiment_command.sh"
    source "${MODULES_DIR}/commands/docs_command.sh"
    source "${MODULES_DIR}/commands/scratchpad_command.sh"
    source "${MODULES_DIR}/commands/kb_command.sh"
    source "${MODULES_DIR}/commands/meta_command.sh"
    source "${MODULES_DIR}/commands/cache_command.sh"
    source "${MODULES_DIR}/commands/config_command.sh"
    source "${MODULES_DIR}/commands/monitor_command.sh"

    # --- INITIALISATION POST-CHARGEMENT ---
    init_cache_dir

    if [ "$AKLO_DRY_RUN" = true ]; then
        echo "ðŸ’§ Mode DRY-RUN activÃ©. Aucune modification ne sera effectuÃ©e."
    fi
    
    # --- DISPATCHER COMPLET ---
    local cmd_function="cmd_$(echo "$command" | tr '-' '_')"
    if declare -f "$cmd_function" >/dev/null; then
        "$cmd_function" "$@"
    else
        echo "Erreur: Commande inconnue '$command'" >&2
        return 1
    fi
}

main "$@"
