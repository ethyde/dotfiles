#!/usr/bin/env bash
#==============================================================================
# AKLO - CHARTE AUTOMATION TOOL (V6 - Dispatcher Complet et Robuste)
#==============================================================================

set -e

# --- DÃ©finition des chemins ---
AKLO_TOOL_DIR=$(dirname "$(dirname "$(realpath "$0")")")
export AKLO_TOOL_DIR
: "${AKLO_PROJECT_ROOT:="$(pwd)"}"
export AKLO_PROJECT_ROOT

# --- Chargement de TOUS les modules ---
source "${AKLO_TOOL_DIR}/modules/core/config.sh"
source "${AKLO_TOOL_DIR}/modules/core/parser.sh"
# Cache
source "${AKLO_TOOL_DIR}/modules/cache/cache_functions.sh"
source "${AKLO_TOOL_DIR}/modules/cache/cache_monitoring.sh"
# Commandes
source "${AKLO_TOOL_DIR}/modules/commands/system_commands.sh"
source "${AKLO_TOOL_DIR}/modules/commands/new_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/pbi_commands.sh"
source "${AKLO_TOOL_DIR}/modules/commands/task_commands.sh"
source "${AKLO_TOOL_DIR}/modules/commands/start-task_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/submit-task_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/merge-task_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/release_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/hotfix_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/debug_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/refactor_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/optimize_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/security_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/experiment_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/docs_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/scratchpad_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/kb_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/meta_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/cache_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/config_command.sh"
source "${AKLO_TOOL_DIR}/modules/commands/monitor_command.sh"

# --- Dispatcher principal ---
main() {
    if [ $# -eq 0 ]; then
        cmd_status --brief
        return 0
    fi
    local command="$1"
    shift
    case "$command" in
        new)            cmd_new "$@" ;;
        plan)           cmd_plan "$@" ;;
        status)         cmd_status "$@" ;;
        init)           cmd_init "$@" ;;
        start-task)     cmd_start-task "$@" ;;
        submit-task)    cmd_submit-task "$@" ;;
        merge-task)     cmd_merge-task "$@" ;;
        release)        cmd_release "$@" ;;
        hotfix)         cmd_hotfix "$@" ;;
        cache)          cmd_cache "$@" ;;
        config)         cmd_config "$@" ;;
        monitor)        cmd_monitor "$@" ;;
        *) echo "Erreur: Commande '$command' inconnue." >&2; exit 1 ;;
    esac
}

main "$@"
