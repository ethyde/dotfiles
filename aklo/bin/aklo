#!/usr/bin/env bash
#==============================================================================
# AKLO - VERSION FINALE STABLE ET MODULAIRE
#==============================================================================

# --- INITIALISATION SÉCURISÉE DU CHEMIN ---
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE"
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" >/dev/null 2>&1 && pwd )"
AKLO_PROJECT_ROOT=$(cd "${SCRIPT_DIR}/../.." && pwd)
export AKLO_PROJECT_ROOT
export AKLO_CACHE_DIR="${AKLO_PROJECT_ROOT}/aklo/.aklo_cache"

# --- DISPATCHER PRINCIPAL ---
main() {
    local command_name="$1"
    if [ -z "$command_name" ]; then
        aklo_help; exit 1;
    fi

    # Fast-path pour les commandes ultra-simples
    case "$command_name" in
        "version"|"help") "aklo_$command_name" "$@"; exit $?;;
    esac

    # Architecture de chargement modulaire
    source "${AKLO_PROJECT_ROOT}/aklo/modules/core/command_classifier.sh"
    
    local profile
    profile=$(classify_command "$command_name")
    
    if [ "$profile" = "UNKNOWN" ]; then
        echo "Erreur: Commande '$command_name' inconnue." >&2
        aklo_help >&2
        exit 1
    fi

    local modules_to_load
    modules_to_load=$(get_required_modules "$profile")

    if [ -n "$modules_to_load" ]; then
        IFS=',' read -ra modules_array <<< "$modules_to_load"
        for module in "${modules_array[@]}"; do
            local module_path="${AKLO_PROJECT_ROOT}/aklo/modules/${module}"
            if [ -f "$module_path" ]; then
                source "$module_path"
            else
                echo "Erreur critique : Dépendance de module introuvable : $module" >&2
                exit 1
            fi
        done
    fi
    
    # Exécution de la commande
    local command_function="cmd_$command_name"
    if declare -f "$command_function" >/dev/null; then
        shift 
        "$command_function" "$@"
    else
        echo "Erreur: La fonction pour la commande '$command_name' n'a pas été trouvée, même après chargement." >&2
        exit 1
    fi
}

main "$@"